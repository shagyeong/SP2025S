<!-- serverproject/attendance/templates/attendance/team_attendance.html -->
{% extends 'instructor/base_instructor.html' %}
{% load static %}

{% block title %}íŒ€ ì¶œê²° ìƒì„¸{% endblock %}

{% block extra_css %}
    {{ block.super }}
    <style>
        .attendance-detail-page {
            background-color: #fff;
            padding: 25px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.08);
            margin-top: 50px;
        }
        .attendance-detail-page h1 {
            font-size: 1.6rem;
            margin-top: 0; /* h1ì˜ ê¸°ë³¸ ìƒë‹¨ ë§ˆì§„ ì œê±° */
            margin-bottom: 1.5rem;
            color: #333;
            border-bottom: 1px solid #eee;
            padding-bottom: 0.8rem;
            display: flex; /* ì•„ì´ì½˜ ì •ë ¬ */
            align-items: center;
        }
        .attendance-detail-page h1 .icon { /* ğŸ“‹ ì•„ì´ì½˜ ìŠ¤íƒ€ì¼ */
            margin-right: 0.75rem;
            font-size: 1.8rem; /* ì•„ì´ì½˜ í¬ê¸° */
        }

        .controls-area {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 1.5rem;
            flex-wrap: wrap;
            padding: 1rem; /* ì»¨íŠ¸ë¡¤ ì˜ì—­ ìì²´ì—ë„ íŒ¨ë”© */
            background-color: #f8f9fa; /* ì•½ê°„ì˜ ë°°ê²½ìƒ‰ */
            border-radius: 6px;
        }
        .controls-area label {
            font-weight: 500;
            color: #4A5568;
        }
        .controls-area #team-name-display-text {
            font-weight: 600;
            font-size: 1.1rem;
            color: #2D3748;
            padding: 0.3rem 0;
            border-bottom: 2px solid #3B82F6; /* ê°•ì¡° ë°‘ì¤„ */
        }
        .controls-area select {
            padding: 0.55rem 0.8rem; /* íŒ¨ë”© í†µì¼ */
            border: 1px solid #D1D5DB;
            border-radius: 0.375rem;
            background-color: white;
            font-size: 0.9rem;
        }
        .btn-action, /* ì¡°íšŒ ë²„íŠ¼ */
        .btn-back {  /* ëŒì•„ê°€ê¸° ë²„íŠ¼ */
            padding: 0.6rem 1.2rem;
            border-radius: 0.375rem;
            cursor: pointer;
            font-weight: 500;
            font-size: 0.9rem;
            text-decoration: none;
            transition: background-color 0.2s ease-in-out, color 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
            border: none;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        .btn-action {
            background-color: #3B82F6;
            color: white;
        }
        .btn-action:hover {
            background-color: #2563EB;
            box-shadow: 0 2px 5px rgba(0,0,0,0.15);
        }
        .btn-back {
            background-color: #6B7280;
            color: white;
            margin-top: 1.5rem;
            display: inline-block;
        }
        .btn-back:hover {
            background-color: #4B5563;
            box-shadow: 0 2px 5px rgba(0,0,0,0.15);
        }

        .attendance-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1.5rem; /* ì»¨íŠ¸ë¡¤ ì˜ì—­ê³¼ì˜ ê°„ê²© */
            font-size: 0.9rem;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05); /* í…Œì´ë¸”ì—ë„ ì•½ê°„ì˜ ê·¸ë¦¼ì */
            border-radius: 6px;
            overflow: hidden; 
        }
        .attendance-table th, .attendance-table td {
            border: 1px solid #E5E7EB;
            padding: 0.8rem 1rem;
            text-align: left;
        }
        .attendance-table th {
            background-color: #F3F4F6; /* í—¤ë” ë°°ê²½ìƒ‰ ë³€ê²½ */
            font-weight: 600;
            color: #1F2937; /* í—¤ë” ê¸€ììƒ‰ ë³€ê²½ */
        }
        .attendance-table td {
            color: #374151; /* ê¸°ë³¸ ì…€ ê¸€ììƒ‰ */
            background-color: #fff; /* ì…€ ë°°ê²½ í°ìƒ‰ */
        }
        .attendance-table td.status-present {
            color: #059669; /* Tailwind green-600 */
            font-weight: 500;
        }
        .attendance-table td.status-absent {
            color: #DC2626; /* Tailwind red-600 */
            font-weight: 500;
        }
    </style>
{% endblock %}

{% block content %}
<div class="attendance-detail-page">
    <h1><span class="icon">ğŸ“‹</span> íŒ€ ì¶œê²° ìƒì„¸</h1>

    <div>
    <div class="controls-area">
        <label for="team-name-display-text">íŒ€ ID: </label>
        <span id="team-name-display-text">íŒ€ ì •ë³´ ë¡œë”© ì¤‘...</span>
        <input type="hidden" id="team-id-hidden">

        <label for="round-select" style="margin-left: auto;">íšŒì°¨: </label> {# íšŒì°¨ ì„ íƒì„ ì˜¤ë¥¸ìª½ìœ¼ë¡œ #}
        <select id="round-select">
            {% for i in rounds %}
              <option value="{{ i }}">{{ i }}íšŒì°¨</option>
            {% endfor %}
          </select>
        <button id="load-team-attendance" class="btn-action">ì¡°íšŒ</button>
    </div>
    </div>

    <table class="attendance-table">
        <thead>
            <tr>
                <th>ì—­í• </th>
                <th>ëª…ë‹¨</th>
                <th>ì¶œê²°</th>
            </tr>
        </thead>
        <tbody id="attendance-body">
            <tr><td colspan="3" style="text-align:center; padding: 1rem;">íŒ€ê³¼ íšŒì°¨ë¥¼ ì„ íƒí•˜ê³  ì¡°íšŒ ë²„íŠ¼ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”.</td></tr>
        </tbody>
    </table>

    <button onclick="goBack()" class="btn-back">ëª©ë¡ìœ¼ë¡œ ëŒì•„ê°€ê¸°</button>
</div>
{% endblock %}

{% block extra_js %}
    {# JavaScriptëŠ” ì´ì „ ë‹µë³€ê³¼ ë™ì¼í•˜ê²Œ ìœ ì§€ #}
    <script>
    function goBack() { window.history.back(); }

    function getQueryParam(param) {
        const urlParams = new URLSearchParams(window.location.search);
        return urlParams.get(param);
    }

    document.addEventListener("DOMContentLoaded", () => {
        const teamNameDisplayText = document.getElementById("team-name-display-text");
        const teamIdHiddenInput = document.getElementById("team-id-hidden");
        const roundSelect = document.getElementById("round-select");
        const attendanceTableBody = document.getElementById("attendance-body");
        const loadButton = document.getElementById("load-team-attendance");

        const initialTeamId = getQueryParam("team_id");
        const initialTeamName = getQueryParam("team_name");

        if (initialTeamId) {
            teamIdHiddenInput.value = initialTeamId;
        }
        if (initialTeamName) {
        teamNameDisplayText.textContent = initialTeamName; // URLì—ì„œ ê°€ì ¸ì˜¨ íŒ€ ì´ë¦„ì„ spanì— ì„¤ì •
        } else if (initialTeamId) {
            // team_name íŒŒë¼ë¯¸í„°ê°€ ì—†ìœ¼ë©´, IDë¼ë„ í‘œì‹œ
            teamNameDisplayText.textContent = `${initialTeamId}`;
        } else {
            // team_idë„ ì—†ìœ¼ë©´
            teamNameDisplayText.textContent = 'íŒ€ ì •ë³´ ì—†ìŒ';
        }

        async function fetchAndRenderAttendance() {
            const teamId = teamIdHiddenInput.value.trim();
            const round = roundSelect.value;

            if (!teamId) {
                alert("íŒ€ ID ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤. ì´ì „ í˜ì´ì§€ì—ì„œ íŒ€ì„ ë‹¤ì‹œ ì„ íƒí•´ì£¼ì„¸ìš”.");
                attendanceTableBody.innerHTML = '<tr><td colspan="3">íŒ€ì„ ì„ íƒí•´ì£¼ì„¸ìš”.</td></tr>';
                return;
            }
            if (!round) {
                alert("íšŒì°¨ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.");
                attendanceTableBody.innerHTML = '<tr><td colspan="3">íšŒì°¨ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.</td></tr>';
                return;
            }

            attendanceTableBody.innerHTML = '<tr><td colspan="3" style="text-align:center; padding:1rem;">ì¶œê²° ì •ë³´ ë¡œë”© ì¤‘...</td></tr>';

            try {
                const response = await fetch(`/api/attendance/att/${teamId}/round/?round=${round}`);
                if (!response.ok) {
                    let errorMsg = `HTTP error! status: ${response.status}`;
                    if (response.status === 404) {
                        try {
                            const errData = await response.json();
                            errorMsg = errData.error || "í•´ë‹¹ íŒ€/íšŒì°¨ì˜ ì¶œê²° ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.";
                        } catch (e) { /* JSON íŒŒì‹± ì‹¤íŒ¨ ì‹œ ê¸°ë³¸ ë©”ì‹œì§€ ì‚¬ìš© */ }
                    }
                    throw new Error(errorMsg);
                }
                const data = await response.json();
                console.log("Fetched attendance data:", data);

                attendanceTableBody.innerHTML = "";

                const teamMembersData = data.team_members;
                if (!teamMembersData) {
                    alert("íŒ€ì› ì •ë³´ë¥¼ API ì‘ë‹µì—ì„œ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. (expected 'team_members' key)");
                    attendanceTableBody.innerHTML = `<tr><td colspan="3">íŒ€ì› ì •ë³´ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</td></tr>`;
                    return;
                }

                const displayFields = [
                    { attendanceKey: "at_leader", roleLabel: "íŒ€ì¥", idKey: "leader_id", nameKey: "leader_name" },
                    { attendanceKey: "at_mate1",  roleLabel: "íŒ€ì›1", idKey: "mate1_id",  nameKey: "mate1_name" },
                    { attendanceKey: "at_mate2",  roleLabel: "íŒ€ì›2", idKey: "mate2_id",  nameKey: "mate2_name" },
                    { attendanceKey: "at_mate3",  roleLabel: "íŒ€ì›3", idKey: "mate3_id",  nameKey: "mate3_name" },
                    { attendanceKey: "at_mate4",  roleLabel: "íŒ€ì›4", idKey: "mate4_id",  nameKey: "mate4_name" }
                ];

                let hasMembers = false;
                displayFields.forEach(fieldInfo => {
                    const studentId = teamMembersData[fieldInfo.idKey];
                    const studentName = teamMembersData[fieldInfo.nameKey] || studentId || "-";
                    const memberDisplay = studentId ? `${studentName} (${studentId})` : (studentName !== "-" ? studentName : "-");

                    if (studentId || (fieldInfo.roleLabel === "íŒ€ì¥" && teamMembersData.leader_id)) {
                        hasMembers = true;
                        const attendanceStatusValue = data[fieldInfo.attendanceKey];
                        let statusText = "-";
                        let statusClass = "";

                        if (attendanceStatusValue === "o" || attendanceStatusValue === "O") {
                            statusText = "ğŸŸ¢ ì¶œì„";
                            statusClass = "status-present";
                        } else if (attendanceStatusValue === "x" || attendanceStatusValue === "X") {
                            statusText = "âŒ ê²°ì„";
                            statusClass = "status-absent";
                        } else if (attendanceStatusValue) {
                            statusText = attendanceStatusValue;
                        }

                        const row = document.createElement("tr");
                        row.innerHTML = `
                            <td>${fieldInfo.roleLabel}</td>
                            <td>${memberDisplay}</td>
                            <td class="${statusClass}">${statusText}</td>
                        `;
                        attendanceTableBody.appendChild(row);
                    }
                });
                 if (!hasMembers) {
                     attendanceTableBody.innerHTML = `<tr><td colspan="3" style="text-align:center; padding:1rem;">ì´ íŒ€ì—ëŠ” í˜„ì¬ ë°°ì •ëœ íŒ€ì›ì´ ì—†ìŠµë‹ˆë‹¤.</td></tr>`;
                 }

            } catch (err) {
                alert("ì¶œê²° ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: " + err.message);
                console.error(err);
                attendanceTableBody.innerHTML = `<tr><td colspan="3" style="text-align:center; padding:1rem;">ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨: ${err.message}</td></tr>`;
            }
        }

        if(loadButton) {
            loadButton.addEventListener("click", fetchAndRenderAttendance);
        }

        if (initialTeamId && roundSelect.value) {
             fetchAndRenderAttendance();
        } else if (!initialTeamId) { // íŒ€ IDê°€ ì²˜ìŒë¶€í„° ì—†ëŠ” ê²½ìš°
            attendanceTableBody.innerHTML = '<tr><td colspan="3" style="text-align:center; padding: 1rem;">íŒ€ì„ ì„ íƒí•˜ê³  íšŒì°¨ë¥¼ ì¡°íšŒí•´ì£¼ì„¸ìš”.</td></tr>';
        }

    });
    </script>
{% endblock %}